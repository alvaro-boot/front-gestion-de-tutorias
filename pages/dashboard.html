<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gesti√≥n de Tutor√≠as</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/components.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üèõÔ∏è Gesti√≥n de Tutor√≠as - Universidad Tecnol√≥gica</h1>
            <div class="nav">
                <span id="userInfo" style="color: white; padding: 8px 15px; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px;"></span>
                <a href="#" id="logoutBtn">Cerrar Sesi√≥n</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="adminNav" style="display: none;">
            <h2 style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600; margin-bottom: 20px;">Panel de Administraci√≥n</h2>
            <div class="grid grid-3">
                <a href="usuarios/listar.html" class="card-link">
                    <div class="card">
                        <h3>üë• Usuarios</h3>
                        <p>Gestionar usuarios del sistema</p>
                    </div>
                </a>
                <a href="materias/listar.html" class="card-link">
                    <div class="card">
                        <h3>üìö Materias</h3>
                        <p>Gestionar materias</p>
                    </div>
                </a>
                <a href="especialidades/gestionar.html" class="card-link">
                    <div class="card">
                        <h3>üéì Especialidades</h3>
                        <p>Asignar especialidades</p>
                    </div>
                </a>
                <a href="solicitudes/listar.html" class="card-link">
                    <div class="card">
                        <h3>üìù Solicitudes</h3>
                        <p>Ver todas las solicitudes</p>
                    </div>
                </a>
                <a href="tutorias/listar.html" class="card-link">
                    <div class="card">
                        <h3>üéØ Tutor√≠as</h3>
                        <p>Gestionar tutor√≠as</p>
                    </div>
                </a>
                <a href="disponibilidad/listar.html" class="card-link">
                    <div class="card">
                        <h3>‚è∞ Disponibilidad</h3>
                        <p>Ver disponibilidad</p>
                    </div>
                </a>
            </div>
        </div>

        <div id="profesorNav" style="display: none;">
            <h2 style="background: var(--gradient-secondary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600; margin-bottom: 20px;">Panel del Profesor</h2>
            <div class="grid grid-3">
                <a href="disponibilidad/listar.html" class="card-link">
                    <div class="card">
                        <h3>‚è∞ Mi Disponibilidad</h3>
                        <p>Gestionar horarios disponibles</p>
                    </div>
                </a>
                <a href="tutorias/listar.html" class="card-link">
                    <div class="card">
                        <h3>üéØ Mis Tutor√≠as</h3>
                        <p>Ver tutor√≠as asignadas</p>
                    </div>
                </a>
                <a href="#" id="profileBtn" class="card-link">
                    <div class="card">
                        <h3>üë§ Mi Perfil</h3>
                        <p>Ver y editar perfil</p>
                    </div>
                </a>
            </div>
        </div>

        <div id="estudianteNav" style="display: none;">
            <h2 style="background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600; margin-bottom: 20px;">Panel del Estudiante</h2>
            <div class="grid grid-3">
                <a href="solicitudes/crear.html" class="card-link">
                    <div class="card">
                        <h3>‚ûï Nueva Solicitud</h3>
                        <p>Crear solicitud de tutor√≠a</p>
                    </div>
                </a>
                <a href="solicitudes/listar.html" class="card-link">
                    <div class="card">
                        <h3>üìù Mis Solicitudes</h3>
                        <p>Ver mis solicitudes</p>
                    </div>
                </a>
                <a href="tutorias/listar.html" class="card-link">
                    <div class="card">
                        <h3>üéØ Mis Tutor√≠as</h3>
                        <p>Ver tutor√≠as asignadas</p>
                    </div>
                </a>
                <a href="#" id="profileBtnEst" class="card-link">
                    <div class="card">
                        <h3>üë§ Mi Perfil</h3>
                        <p>Ver y editar perfil</p>
                    </div>
                </a>
            </div>
        </div>

        <div id="statsSection" style="display: none;">
            <h2 style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600; margin-bottom: 20px;">Estad√≠sticas</h2>
            <div class="grid grid-3" id="statsGrid"></div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        // Esperar a que el DOM est√© completamente cargado
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Verificar autenticaci√≥n
                if (!auth.checkAuth()) {
                    return;
                }

                const user = storage.getUser();
                if (!user) {
                    console.error('Usuario no encontrado en storage');
                    auth.logout();
                    return;
                }

                // Mostrar informaci√≥n del usuario
                const userInfo = document.getElementById('userInfo');
                if (userInfo) {
                    const roles = user.roles && Array.isArray(user.roles) ? user.roles.join(', ') : 'Sin rol';
                    userInfo.textContent = `${user.nombre || 'Usuario'} (${roles})`;
                }

                // Mostrar navegaci√≥n seg√∫n rol
                let navShown = false;
                if (auth.isAdmin()) {
                    const adminNav = document.getElementById('adminNav');
                    const statsSection = document.getElementById('statsSection');
                    if (adminNav) adminNav.style.display = 'block';
                    if (statsSection) statsSection.style.display = 'block';
                    navShown = true;
                    loadStats();
                } else if (auth.isProfesor()) {
                    const profesorNav = document.getElementById('profesorNav');
                    if (profesorNav) profesorNav.style.display = 'block';
                    navShown = true;
                } else if (auth.isEstudiante()) {
                    const estudianteNav = document.getElementById('estudianteNav');
                    if (estudianteNav) estudianteNav.style.display = 'block';
                    navShown = true;
                }

                // Si no se mostr√≥ ninguna navegaci√≥n, mostrar mensaje
                if (!navShown) {
                    const container = document.querySelector('.container');
                    if (container) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <h2 style="color: #dc143c; margin-bottom: 20px;">‚ö†Ô∏è Error de Permisos</h2>
                                <p style="color: #666; margin-bottom: 20px;">No se pudo determinar tu rol en el sistema.</p>
                                <p style="color: #666;">Por favor, contacta al administrador.</p>
                                <button onclick="auth.logout()" style="margin-top: 20px; padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Cerrar Sesi√≥n
                                </button>
                            </div>
                        `;
                    }
                }

                // Logout
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        auth.logout();
                    });
                }

            } catch (error) {
                console.error('Error inicializando dashboard:', error);
                utils.showError('Error al cargar el dashboard. Por favor, recarga la p√°gina.');
            }
        });

        // Cargar estad√≠sticas (solo admin)
        async function loadStats() {
            try {
                const statsGrid = document.getElementById('statsGrid');
                if (!statsGrid) return;

                // Mostrar loading
                statsGrid.innerHTML = '<div style="text-align: center; padding: 20px;">Cargando estad√≠sticas...</div>';

                const [usuarios, materias, solicitudes, tutorias] = await Promise.all([
                    api.get('/usuarios').catch(() => []),
                    api.get('/materias').catch(() => []),
                    api.get('/solicitudes').catch(() => []),
                    api.get('/tutorias').catch(() => [])
                ]);

                statsGrid.innerHTML = `
                    <div class="stats-card">
                        <h3>${usuarios && Array.isArray(usuarios) ? usuarios.length : 0}</h3>
                        <p>Usuarios</p>
                    </div>
                    <div class="stats-card">
                        <h3>${materias && Array.isArray(materias) ? materias.length : 0}</h3>
                        <p>Materias</p>
                    </div>
                    <div class="stats-card">
                        <h3>${solicitudes && Array.isArray(solicitudes) ? solicitudes.length : 0}</h3>
                        <p>Solicitudes</p>
                    </div>
                    <div class="stats-card">
                        <h3>${tutorias && Array.isArray(tutorias) ? tutorias.length : 0}</h3>
                        <p>Tutor√≠as</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                const statsGrid = document.getElementById('statsGrid');
                if (statsGrid) {
                    statsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc143c;">Error al cargar estad√≠sticas</div>';
                }
            }
        }
    </script>
</body>
</html>
